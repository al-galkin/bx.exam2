# [ex2-108] link rel="canonical" для детальной новости

*Подробное описание задачи смотреть в материалах https://academy.1c-bitrix.ru/certification/exams.php*

## Общие требования

* Задачу решить через свойство страницы и расширение возможностей типового компонента news.detail. Компонент расположен по адресу /news/ в составе комплексного и отображает детальную страницу новости. Комплексный компонент отображает данные из инфоблока Новости.

* Создание нового компонента или подмена стандартного через local будет неверным решением, компонент должен остаться типовой. Нужно воспользоваться расширением его возможностей с помощью специальных файлов шаблона.

* Алгоритм решения, при котором будет использоваться некэшируемое обращение к базе данных - не будет верным.

## Решаемая задача

* Создать информационный блок Canonical (тип Новости)

* В созданном информационном блоке создать свойство Новость, тип: привязка к информационному блоку Новости.

* Добавить элемент в инфоблок Canonical
    * Название - http://test.ru/test/
    * Привязка к новости - [2] Международная мебельная выставка SALON DEL MOBILE

* В настройки компонентов news и news.detail добавить строковый параметр: «ID информационного блока для rel=canonical». Значение параметра передавать из настроек комплексного компонента news в news.detail на соответствующей странице комплексного компонента.

* Создать свойство страницы «canonical», добавить в шаблоне сайта вывод значения свойства в шаблоне сайта в блоке ```<head>```.

* Доработать шаблон компонента news.detail для раздела /news/:
    * если в параметрах задан «ID информационного блока для rel=canonical» - найти элемент из соответствующего инфоблока (в нашем случае это Canonical) с привязкой к текущей новости
    *если элемент найден - указать свойство страницы canonical равное: ```<link rel="canonical" href="http://test.ru/test/">```, где http://test.ru/test/ - название элемента инфоблока Canonical

* Проверить, что на детальной странице новости «Международная мебельная выставка SALON DEL MOBILE» в <head> страницы появилась строка ```<link rel="canonical" href="http://test.ru/test/">```

## Решение

* Задание очень похоже на [ex2-34]

* Создаём ИБ

* Создаём свойство в ИБ (задаём символьный код, права доступа - Для всех пользователей: Чтение)

* Добавляем элемент

* Добавляем фразу для параметра в lang-файл - .parameters.php

* Добавляем пункт в "дополнительные настройки" - .parameters.php (тип - строка, значение по умолчанию - не нужно)

* Добавляем в detail.php наш параметр (передача вызова из комплексного news в news.detail)

* Добавляем свойство в "Управление структурой" через админку

* Пропишем в настройках, ID информационного блока для rel=canonical = 5

* Добавляем вывод ShowProperty в header.php

* Добавляем local/templates/furniture_pale-blue/components/bitrix/news/.default/bitrix/news.detail/.default/result_modifier.php
    * В result_modifier.php расширяем $arResult добавляя в него новый ключ CANONICAL, значением которого будет являться поля привязанного элемента и с помощью функции CBitrixComponent::setResultCacheKeys передаем данный ключ в некешируемую область, файл component_epilog.php

* Добавляем local/templates/furniture_pale-blue/components/bitrix/news/.default/bitrix/news.detail/.default/component_epilog.php
    * В component_epilog.php происходит проверка на наличие в массиве $arResult ключа CANONICAL и если условие выполняется, мы устанавливаем заданное свойство страницы

* Убираем код вывода ShowProperty из header.php, чтобы не было вывода с пустым параметром

## Полезные ссылки

* https://ro-man.su/blog/video_lessons/bitrix-exam-2/lesson-2/ (страница и видео на YouTube были удалены автором)

____
* [Задания](tasks.md)
* [README.md](../../README.md)